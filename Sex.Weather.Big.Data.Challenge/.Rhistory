#
#
#==== General ==================================================================
#
# This file contains code that pertains to the following aspects of the
# sex-weather project:
#
# 1. File Management
# 2. Libraries
# 3. Global Variables
# 4. Run Custom Codes
#
#
R.version.string
# "R version 3.6.2 (2019-12-12)"
sessionInfo()  # for more info
#==== 1. Libraries==============================================================
# libraries needed for downloading gtrends and weather data
library(rnoaa)
library(gtrendsR)
# if you don't have the library yet, please install it! Either with the script
# below, or with the "Install Packages..." option under the 'Tools' menu
# install.packages("rnoaa")
# install.packages("gtrendsR")
#======== 2. File Management ===================================================
# working directory
wd <- getwd()
# folders for storing data outputs and figures
# store names of the folders in an object
output.folder.names <- c("figures", "data.output")
# and make the folders if they don't exist yet.
for(i in 1:length(output.folder.names))
if(file.exists(output.folder.names[i]) == FALSE)
dir.create(output.folder.names[i])
#path to figures folder
path.figures <- paste(wd,"/",output.folder.names[1],"/", sep = "")
#path to data folder
path.data <- paste(wd,"/",output.folder.names[2],"/", sep = "")
#===== 3. Global Variables =====================================================
countries <- gtrendsR::countries
categories <- gtrendsR::categories
# city populations, latitudes, and longitudes data modified from:
# https://simplemaps.com/data/us-cities
cities <- read.csv("cities.csv",
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
# removing cities with populations under 50,000
big.cities <- subset(cities, Population > 50000)
# What is the category id for sexual enhancement?
se <- categories$id[categories$name == "Sexual Enhancement"]
# [1] "1236"
#============================ 4. Run Custom Codes ==============================
# # Run Saving.Search.Data script
# source("saving.search.data.R")
# # Run comparison script
# source("comparison.R")
#============================ End of Main ======================================
for(i in 1:length(big.cities$name)){
weath <- read.csv(paste(path.data, big.cities$name[i], ".weather.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
gtrend <- read.csv(paste(path.data, big.cities$name[i], ".gtrends.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
# reducing date and time to just date for weather data
weath$ymd <- substr(weath$date, 1, 10)
# names for each day of the year in weather dataset
dates <- unique(weath$ymd)
# this loop creates a vector with the mean temperature for each day of year
daily.temp <- rep(NA, 365)
for(y in 1:length(unique(weath$ymd))){
daily.temp[y] <- mean(as.numeric(weath$temperature[weath$ymd == dates[y]]),
na.rm = TRUE)
}  # end of daily temperature loop
# combine gtrends and weather data by day of year
gtrend.weath <- data.frame("date" = dates, "gtrend.hits" = gtrend$hits,
temperature = daily.temp)
filename <- paste(big.cities$name[i], "comparison.pdf", sep = ".")
# start saving of pdf
pdf(paste(path.figures, paste(filename), sep = ""),
width = 5, height = 5)
plot(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
xlab = "Temperature", ylab = "Hits", las = 1,
main = "Google Searches for Sexual Enhancement")
# stop saving
dev.off()
}  # end of comparison loop
# execute the weather data download function
download.gtrends.data()
# # Run Saving.Search.Data script
source("2.saving.search.data.R")
for(i in 1:length(big.cities$name)){
weath <- read.csv(paste(path.data, big.cities$name[i], ".weather.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
gtrend <- read.csv(paste(path.data, big.cities$name[i], ".gtrends.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
# reducing date and time to just date for weather data
weath$ymd <- substr(weath$date, 1, 10)
# names for each day of the year in weather dataset
dates <- unique(weath$ymd)
# this loop creates a vector with the mean temperature for each day of year
daily.temp <- rep(NA, 365)
for(y in 1:length(unique(weath$ymd))){
daily.temp[y] <- mean(as.numeric(weath$temperature[weath$ymd == dates[y]]),
na.rm = TRUE)
}  # end of daily temperature loop
# combine gtrends and weather data by day of year
gtrend.weath <- data.frame("date" = dates, "gtrend.hits" = gtrend$hits,
temperature = daily.temp)
filename <- paste(big.cities$name[i], "comparison.pdf", sep = ".")
# start saving of pdf
pdf(paste(path.figures, paste(filename), sep = ""),
width = 5, height = 5)
plot(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
xlab = "Temperature", ylab = "Hits", las = 1,
main = "Google Searches for Sexual Enhancement")
# stop saving
dev.off()
}  # end of comparison loop
daily.temp
dates
gtrend$hits
temperature = daily.temp
daily.temp
gtrend$hits
daily.temp
dates
unique(weath$ymd)
weath$date
weath$ymd
unique(weath$ymd)
for(i in 1:length(big.cities$name)){
weath <- read.csv(paste(path.data, big.cities$name[i], ".weather.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
gtrend <- read.csv(paste(path.data, big.cities$name[i], ".gtrends.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
# reducing date and time to just date for weather data
weath$ymd <- substr(weath$date, 1, 10)
# names for each day of the year in weather dataset
dates <- unique(weath$ymd)
# this loop creates a vector with the mean temperature for each day of year
daily.temp <- rep(NA, 365)
for(y in 1:length(unique(weath$ymd))){
daily.temp[y] <- mean(as.numeric(weath$temperature[weath$ymd == dates[y]]),
na.rm = TRUE)
}  # end of daily temperature loop
# combine gtrends and weather data by day of year
gtrend.weath <- data.frame("date" = dates,
"gtrend.hits" = gtrend$hits[1:length(dates)],
"temperature" = daily.temp[1:length(dates)])
filename <- paste(big.cities$name[i], "comparison.pdf", sep = ".")
# start saving of pdf
pdf(paste(path.figures, paste(filename), sep = ""),
width = 5, height = 5)
plot(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
xlab = "Temperature", ylab = "Hits", las = 1,
main = "Google Searches for Sexual Enhancement")
# stop saving
dev.off()
}  # end of comparison loop
for(i in 1:length(big.cities$name)){
weath <- read.csv(paste(path.data, big.cities$name[i], ".weather.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
gtrend <- read.csv(paste(path.data, big.cities$name[i], ".gtrends.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
# reducing date and time to just date for weather data
weath$ymd <- substr(weath$date, 1, 10)
# names for each day of the year in weather dataset
dates <- unique(weath$ymd)
# this loop creates a vector with the mean temperature for each day of year
daily.temp <- rep(NA, 365)
for(y in 1:length(unique(weath$ymd))){
daily.temp[y] <- mean(as.numeric(weath$temperature[weath$ymd == dates[y]]),
na.rm = TRUE)
}  # end of daily temperature loop
# combine gtrends and weather data by day of year
gtrend.weath <- data.frame("date" = dates,
"gtrend.hits" = gtrend$hits[1:length(dates)],
"temperature" = daily.temp[1:length(dates)])
filename <- paste(big.cities$name[i], "comparison.pdf", sep = ".")
# start saving of pdf
pdf(paste(path.figures, paste(filename), sep = ""),
width = 5, height = 5)
plot(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
xlab = "Temperature (F)", ylab = "Hits", las = 1,
xlim = c(0, 90),
main = "Google Searches for Sexual Enhancement")
# stop saving
dev.off()
}  # end of comparison loop
for(i in 1:length(big.cities$name)){
weath <- read.csv(paste(path.data, big.cities$name[i], ".weather.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
gtrend <- read.csv(paste(path.data, big.cities$name[i], ".gtrends.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
# reducing date and time to just date for weather data
weath$ymd <- substr(weath$date, 1, 10)
# names for each day of the year in weather dataset
dates <- unique(weath$ymd)
# this loop creates a vector with the mean temperature for each day of year
daily.temp <- rep(NA, 365)
for(y in 1:length(unique(weath$ymd))){
daily.temp[y] <- mean(as.numeric(weath$temperature[weath$ymd == dates[y]]),
na.rm = TRUE)
}  # end of daily temperature loop
# combine gtrends and weather data by day of year
gtrend.weath <- data.frame("date" = dates,
"gtrend.hits" = gtrend$hits[1:length(dates)],
"temperature" = daily.temp[1:length(dates)])
filename <- paste(big.cities$name[i], "comparison.pdf", sep = ".")
# start saving of pdf
pdf(paste(path.figures, paste(filename), sep = ""),
width = 5, height = 5)
plot(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
xlab = "Temperature (F)", ylab = "Hits", las = 1,
xlim = c(0, 90),
main = "Google Searches for Sexual Enhancement")
# stop saving
dev.off()
}  # end of comparison loop
for(i in 1:length(big.cities$name)){
weath <- read.csv(paste(path.data, big.cities$name[i], ".weather.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
gtrend <- read.csv(paste(path.data, big.cities$name[i], ".gtrends.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
# reducing date and time to just date for weather data
weath$ymd <- substr(weath$date, 1, 10)
# names for each day of the year in weather dataset
dates <- unique(weath$ymd)
# this loop creates a vector with the mean temperature for each day of year
daily.temp <- rep(NA, 365)
for(y in 1:length(unique(weath$ymd))){
daily.temp[y] <- mean(as.numeric(weath$temperature[weath$ymd == dates[y]]),
na.rm = TRUE)
}  # end of daily temperature loop
# combine gtrends and weather data by day of year
gtrend.weath <- data.frame("date" = dates,
"gtrend.hits" = gtrend$hits[1:length(dates)],
"temperature" = daily.temp[1:length(dates)])
filename <- paste(big.cities$name[i], "comparison.pdf", sep = ".")
# start saving of pdf
pdf(paste(path.figures, paste(filename), sep = ""),
width = 5, height = 5)
plot(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
xlab = "Temperature (F)", ylab = "Hits", las = 1,
xlim = c(0, 90),
main = "Google Searches for Sexual Enhancement")
# stop saving
dev.off()
}  # end of comparison loop
warnings()
plot(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
xlab = "Temperature (F)", ylab = "Hits", las = 1,
xlim = c(0, 90),
main = "Google Searches for Sexual Enhancement")
for(i in 1:length(big.cities$name)){
weath <- read.csv(paste(path.data, big.cities$name[i], ".weather.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
gtrend <- read.csv(paste(path.data, big.cities$name[i], ".gtrends.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
# reducing date and time to just date for weather data
weath$ymd <- substr(weath$date, 1, 10)
# names for each day of the year in weather dataset
dates <- unique(weath$ymd)
# this loop creates a vector with the mean temperature for each day of year
daily.temp <- rep(NA, 365)
for(y in 1:length(unique(weath$ymd))){
daily.temp[y] <- mean(as.numeric(weath$temperature[weath$ymd == dates[y]]),
na.rm = TRUE)
}  # end of daily temperature loop
# combine gtrends and weather data by day of year
gtrend.weath <- data.frame("date" = dates,
"gtrend.hits" = gtrend$hits[1:length(dates)],
"temperature" = daily.temp[1:length(dates)])
filename <- paste(big.cities$name[i], "comparison.pdf", sep = ".")
# start saving of pdf
pdf(paste(path.figures, paste(filename), sep = ""),
width = 5, height = 5)
plot(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
xlab = "Temperature (F)", ylab = "Hits", las = 1,
xlim = c(0, 90),
main = "Google Searches for Sexual Enhancement")
# stop saving
dev.off()
}  # end of comparison loop
paste(big.cities$name[i], "comparison.pdf", sep = ".")
download.gtrends.data <- function(){
# loop to create .csv for first half of gtrends queries
for(i in 1:(length(big.cities$name)/2)){
# querying gtrends for first half of year and saving to object
first.6mo <- gtrendsR::gtrends(geo = as.character(big.cities[i,3]),
category = 1236,
time = "2018-01-01 2018-06-30",
onlyInterest = TRUE)
# querying gtrends for second half of year and saving to object
second.6mo <- gtrendsR::gtrends(geo = as.character(big.cities[i,3]),
category = 1236,
time = "2018-07-01 2018-12-31",
onlyInterest = TRUE)
# combining first and second half to get whole year interest over time
iot <- rbind(first.6mo$interest_over_time, second.6mo$interest_over_time)
# saving combined interest over time to .csv
write.csv(iot, paste(wd, "/data.output/", as.character(big.cities[i,1]),
".gtrends", ".csv", sep = ""))
}  # end of loop
# loop to create .csv for second half of gtrends queries
for(i in (length(big.cities$name)/2):length(big.cities$name)){
# querying gtrends for first half of year and saving to object
first.6mo <- gtrendsR::gtrends(geo = as.character(big.cities[i,3]),
category = 1236,
time = "2018-01-01 2018-06-30",
onlyInterest = TRUE)
# querying gtrends for second half of year and saving to object
second.6mo <- gtrendsR::gtrends(geo = as.character(big.cities[i,3]),
category = 1236,
time = "2018-07-01 2018-12-31",
onlyInterest = TRUE)
# combining first and second half to get whole year interest over time
iot <- rbind(first.6mo$interest_over_time, second.6mo$interest_over_time)
# saving combined interest over time to .csv
write.csv(iot, paste(wd, "/data.output/", as.character(big.cities[i,1]),
".gtrends", ".csv", sep = ""))
}  # end of loop
# checking presence of gtrend .csvs
fcsv.check.gtrend <- function(){        # function definition
csv.check <- rep(NA, 178)             # vector: Boolean .csv presence
for(i in 1:length(big.cities$name)){  # loop checks .csvs for all cities
# populating vector w/ Boolean presence
csv.check[i] <- file.exists(paste(wd, "/data.output/",
as.character(big.cities[i,1]),
".gtrends", ".csv", sep = ""))
}
# which cities don't have a gtrends query .csv?
print("Are there any missing gtrends query .csvs?")
return(big.cities$name[which(csv.check == FALSE)])
}
# Running the function - do any cities not have a gtrends query .csv?
fcsv.check.gtrend()
}  # end of gtrends query download function
# execute the gtrends data download function
download.gtrends.data()
for(i in 1:length(big.cities$name)){
weath <- read.csv(paste(path.data, big.cities$name[i], ".weather.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
gtrend <- read.csv(paste(path.data, big.cities$name[i], ".gtrends.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
# reducing date and time to just date for weather data
weath$ymd <- substr(weath$date, 1, 10)
# names for each day of the year in weather dataset
dates <- unique(weath$ymd)
# this loop creates a vector with the mean temperature for each day of year
daily.temp <- rep(NA, 365)
for(y in 1:length(unique(weath$ymd))){
daily.temp[y] <- mean(as.numeric(weath$temperature[weath$ymd == dates[y]]),
na.rm = TRUE)
}  # end of daily temperature loop
# combine gtrends and weather data by day of year
gtrend.weath <- data.frame("date" = dates,
"gtrend.hits" = gtrend$hits[1:length(dates)],
"temperature" = daily.temp[1:length(dates)])
filename <- paste(big.cities$name[i], "comparison.pdf", sep = ".")
# start saving of pdf
pdf(paste(path.figures, paste(filename), sep = ""),
width = 5, height = 5)
plot(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
xlab = "Temperature (F)", ylab = "Hits", las = 1,
xlim = c(0, 110),
main = "Google Searches for Sexual Enhancement")
abline(lm(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0]),
xlim = c(0, 110))
# stop saving
dev.off()
}  # end of comparison loop
plot(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
xlab = "Temperature (F)", ylab = "Hits", las = 1,
xlim = c(0, 110),
main = "Google Searches for Sexual Enhancement")
abline(lm(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
na.action = na.omit),
plot(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
xlab = "Temperature (F)", ylab = "Hits", las = 1,
xlim = c(0, 110),
main = "Google Searches for Sexual Enhancement")
abline(lm(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
na.action = na.omit),
xlim = c(0, 110))
plot(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
xlab = "Temperature (F)", ylab = "Hits", las = 1,
xlim = c(0, 110),
main = "Google Searches for Sexual Enhancement")
abline(lm(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
na.action = na.exclude),
xlim = c(0, 110))
for(i in 1:length(big.cities$name)){
weath <- read.csv(paste(path.data, big.cities$name[i], ".weather.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
gtrend <- read.csv(paste(path.data, big.cities$name[i], ".gtrends.csv",
sep = ""),
stringsAsFactors = FALSE,
strip.white = TRUE,
na.strings = c(NA, ""))
# reducing date and time to just date for weather data
weath$ymd <- substr(weath$date, 1, 10)
# names for each day of the year in weather dataset
dates <- unique(weath$ymd)
# this loop creates a vector with the mean temperature for each day of year
daily.temp <- rep(NA, 365)
for(y in 1:length(unique(weath$ymd))){
daily.temp[y] <- mean(as.numeric(weath$temperature[weath$ymd == dates[y]]),
na.rm = TRUE)
}  # end of daily temperature loop
# combine gtrends and weather data by day of year
gtrend.weath <- data.frame("date" = dates,
"gtrend.hits" = gtrend$hits[1:length(dates)],
"temperature" = daily.temp[1:length(dates)])
filename <- paste(big.cities$name[i], "comparison.pdf", sep = ".")
# start saving of pdf
pdf(paste(path.figures, paste(filename), sep = ""),
width = 5, height = 5)
plot(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
xlab = "Temperature (F)", ylab = "Hits", las = 1,
xlim = c(0, 110),
main = "Google Searches for Sexual Enhancement")
abline(lm(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
na.action = na.exclude),
xlim = c(0, 110))
# stop saving
dev.off()
}  # end of comparison loop
plot(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0],
xlab = "Temperature (F)", ylab = "Hits", las = 1,
xlim = c(0, 110),
main = "Google Searches for Sexual Enhancement")
abline(lm(gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0] ~
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0]),
xlim = c(0, 110))
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0])
gtrend.weath$temperature[gtrend.weath$gtrend.hits > 0]
gtrend.weath$gtrend.hits[gtrend.weath$gtrend.hits > 0]
gtrend.weath
# names for each day of the year in weather dataset
dates <- unique(weath$ymd)
dates
